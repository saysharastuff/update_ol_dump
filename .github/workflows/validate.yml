name: Validate OpenLibrary Workflow

on:
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          pip install pandas pyarrow huggingface_hub requests

      - name: Check Hugging Face auth token
        run: |
          if [ -z "$HF_TOKEN" ]; then
            echo "❌ HF_TOKEN not set"
            exit 1
          else
            echo "✅ HF_TOKEN is set"
          fi

      - name: Simulate fetch and upload (dry run)
        run: |
          python workflow/fetch_and_upload.py --dry-run

      - name: Create small sample JSON.gz
        run: |
          mkdir -p test
          echo '{"type": "work", "title": "Test Work"}' > test/test_data.json
          echo '{"type": "edition", "title": "Test Edition"}' >> test/test_data.json
          gzip -f test/test_data.json

      - name: Validate parquet conversion on fixture (dry run)
        run: |
          python workflow/convert_to_parquet.py test/test_data.json.gz test/test_output --dry-run

      - name: Report disk space
        run: df -h
